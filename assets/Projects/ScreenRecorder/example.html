<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="">
    <style>
        video {
            width: 640px;
            height: 480px;
            border: 1px solid grey;
        }
        
        #preview {
            border-radius: 50%;
            object-fit: cover;
        }
    </style>
</head>

<body>
    <p id="warning">
        Enable chrome://flags/#enable-experimental-web-platform-features
    </p>
    <div class="left">
        <h2>Preview</h2>
        <video id="preview" autoplay muted></video>
        <video id="videoElement" autoplay muted></video>
    </div>
    <div class="right">
        <div id="startButton" class="button">
            <button>Start</button>
        </div>
        <div id="stopButton" class="button">
            <button>Stop</button>
        </div>
        <div id="log">

        </div>
        <input type="checkbox" id="audioToggle" />
        <label for="audioToggle">Capture Audio from Desktop</label>
        <input type="checkbox" id="micAudioToggle" />
        <label for="micAudioToggle">Capture Audio from Microphone</label>
        <div id="captureVideoButton" class="button">
            <button>Capture Settings</button>
        </div>
        <div id="startVideoButton" class="button">
            <button>Start</button>
        </div>
        <div id="stopVideoButton" class="button">
            <button>Stop</button>
        </div>
        <h2>Recording</h2>
        <video id="recording" width="160" height="120" controls></video>
        <a id="downloadButton" class="button">
          Download
        </a>
    </div>

    <script>
        // Video Cam Settings
        let preview = document.getElementById("preview");
        let recording = document.getElementById("recording");
        let startButton = document.getElementById("startButton");
        let stopButton = document.getElementById("stopButton");
        let downloadButton = document.getElementById("downloadButton");
        let logElement = document.getElementById("log");

        let recordingTimeMS = 5000;

        function log(msg) {
            logElement.innerHTML += msg + "\n";
        }

        function wait(delayInMS) {
            return new Promise(resolve => setTimeout(resolve, delayInMS));
        }

        function startRecording(stream, lengthInMS) {
            let recorder = new MediaRecorder(stream);
            let data = [];

            recorder.ondataavailable = event => data.push(event.data);
            recorder.start();
            log(recorder.state + " for " + (lengthInMS / 1000) + " seconds...");

            let stopped = new Promise((resolve, reject) => {
                recorder.onstop = resolve;
                recorder.onerror = event => reject(event.name);
            });

            let recorded = wait(lengthInMS).then(
                () => recorder.state == "recording" && recorder.stop()
            );

            return Promise.all([
                    stopped,
                    recorded
                ])
                .then(() => data);
        }

        function stop(stream) {
            stream.getTracks().forEach(track => track.stop());
        }

        startButton.addEventListener("click", function() {
            navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                }).then(stream => {
                    preview.srcObject = stream;
                    downloadButton.href = stream;
                    preview.captureStream = preview.captureStream || preview.mozCaptureStream;
                    return new Promise(resolve => preview.onplaying = resolve);
                }).then(() => startRecording(preview.captureStream(), recordingTimeMS))
                .then(recordedChunks => {
                    let recordedBlob = new Blob(recordedChunks, {
                        type: "video/webm"
                    });
                    recording.src = URL.createObjectURL(recordedBlob);
                    downloadButton.href = recording.src;
                    downloadButton.download = "RecordedVideo.webm";

                    log("Successfully recorded " + recordedBlob.size + " bytes of " +
                        recordedBlob.type + " media.");
                })
                .catch(log);
        }, false);



        // Video Screen Recorder Settings
        let warningElement = document.getElementById('warning');
        if ('getDisplayMedia' in navigator.mediaDevices) warningElement.style.display = 'none';
        const videoElement = document.getElementById('videoElement');
        const audioToggle = document.getElementById('audioToggle');
        const micAudioToggle = document.getElementById('micAudioToggle');



        let captureVideoButton = document.getElementById("captureVideoButton");
        let startVideoButton = document.getElementById("startVideoButton");
        let stopVideoButton = document.getElementById("stopVideoButton");

        const mergeAudioStreams = (desktopStream, voiceStream) => {
            const context = new AudioContext();
            const destination = context.createMediaStreamDestination();
            let hasDesktop = false;
            let hasVoice = false;
            if (desktopStream && desktopStream.getAudioTracks().length > 0) {
                // If you don't want to share Audio from the desktop it should still work with just the voice.
                const source1 = context.createMediaStreamSource(desktopStream);
                const desktopGain = context.createGain();
                desktopGain.gain.value = 0.7;
                source1.connect(desktopGain).connect(destination);
                hasDesktop = true;
            }

            if (voiceStream && voiceStream.getAudioTracks().length > 0) {
                const source2 = context.createMediaStreamSource(voiceStream);
                const voiceGain = context.createGain();
                voiceGain.gain.value = 0.7;
                source2.connect(voiceGain).connect(destination);
                hasVoice = true;
            }

            return (hasDesktop || hasVoice) ? destination.stream.getAudioTracks() : [];
        };


        let voiceStream;
        let webcamStream;
        let desktopStream;

        captureVideoButton.onclick = async() => {
            // download.style.display = 'none';
            const audio = audioToggle.checked || false;
            const mic = micAudioToggle.checked || false;

            desktopStream = await navigator.mediaDevices.getDisplayMedia({
                video: true,
                audio: audio
            });

            webcamStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            })

            if (mic === true) {
                voiceStream = await navigator.mediaDevices.getUserMedia({
                    video: false,
                    audio: mic
                });
            }

            const tracks = [
                ...desktopStream.getVideoTracks(),
                ...webcamStream.getVideoTracks(),
                ...mergeAudioStreams(desktopStream, voiceStream)
            ];

            console.log('Tracks to add to stream', tracks);
            stream = new MediaStream(tracks);
            console.log('Stream', stream)
            videoElement.srcObject = stream;
            videoElement.muted = true;

            blobs = [];

            rec = new MediaRecorder(stream, {
                mimeType: 'video/webm; codecs=vp8,opus'
            });
            rec.ondataavailable = (e) => blobs.push(e.data);
            rec.onstop = async() => {

                //blobs.push(MediaRecorder.requestData());
                blob = new Blob(blobs, {
                    type: 'video/webm'
                });
                let url = window.URL.createObjectURL(blob);
                download.href = url;
                download.download = 'test.webm';
                download.style.display = 'block';
            };
            // startBtn.disabled = false;
            // captureBtn.disabled = true;
            // audioToggle.disabled = true;
            // micAudioToggle.disabled = true;
        };

        stopButton.addEventListener("click", function() {
            stop(preview.srcObject);
        }, false);


        startVideoButton.addEventListener("click", function() {

        });
    </script>
</body>

</html>